on("add:graphic",e=>{const{token:t,represents:o}=identifyToken(e);isNPC(t)&&(trackNPCToken(t,o),setNPCTokenHP(t,o),setTimeout(()=>selectTokenSide(t,o),NPC_SETUP_TIME),setTimeout(()=>setOrdinalTokenName(t,o),NPC_SETUP_TIME))}),on("change:graphic",(e,t)=>{isObjectToken(e)&&hasObjectMoved(e,t)&&(setTokenRotation(e),isFollower(e.id)&&unfollowToken(e.id),hasFollowers(e.id)&&state.writh.followers[e.id].forEach(t=>moveFollower(t,e.id)))}),on("chat:message",e=>{"api"===e.type&&processCommand(e)}),on("destroy:graphic",e=>{const{token:t,represents:o}=identifyToken(e);isNPC(t)&&untrackNPCToken(t,o)}),on("ready",()=>{state.writh=state.writh||{},state.writh.npcs=state.writh.npcs||{},state.writh.followers=state.writh.followers||{}});function calculateRotation(t,e){const o=e.top-t.top,n=e.left-t.left;let l=180*Math.atan2(o,n)/Math.PI;return(l+=BIAS)>=360&&(l-=360),l<0&&(l+=360),SNAP_TO_GRID&&(l=closestRotation(l)),l}function closestRotation(t){let e=720,o=ROTATIONS.length;for(;o--;)Math.abs(t-ROTATIONS[o])<Math.abs(t-e)&&(e=ROTATIONS[o]);return e}function hasObjectMoved(t,e){return t.get("left")!=e.left||t.get("top")!=e.top}function parseMoves(t){let e=(t=t.split(",").reverse()).length;const o=[];for(;e;)o.push(new Move({left:Math.floor(t[--e]),top:Math.floor(t[--e])}));return o}function setTokenRotation(t){const e=parseMoves(t.get("lastmove"));e.push(new Move({left:Math.ceil(t.get("left")),top:Math.ceil(t.get("top"))}));let o=e.length;const n=e[--o],l=e[--o];t.set("rotation",calculateRotation(l,n))}const BIAS=45,ROTATIONS=[0,45,90,135,180,225,270,315],SNAP_TO_GRID=!1;class Move{constructor({top:t,left:e}){this.top=t,this.left=e}}function follow(t,o,e){if(o===e)return unfollowToken(o);followToken(o,e)}function getLeaderId(t){return _.findKey(state.writh.followers,o=>o.includes(t))}function isFollower(t){return!!getLeaderId(t)}function hasFollowers(t){return Array.isArray(state.writh.followers[t])&&state.writh.followers[t].length>0}function followToken(t,o){state.writh.followers[o]=state.writh.followers[o]||[],state.writh.followers[o].push(t),moveFollower(t,o);const e=getTokenById(t).get("name"),l=getTokenById(o).get("name");sendChat("System",`${e} is now following ${l}.`)}function moveFollower(t,o){const e=getTokenById(t),l=getTokenById(o),n=Math.floor(l.get("left")),r=Math.floor(l.get("top")),s=(Math.floor(l.get("height")),Math.floor(l.get("width")),Math.floor(e.get("height")),Math.floor(e.get("width")),n),f=r;e.set("left",s),e.set("top",f),e.set("rotation",l.get("rotation"))}function unfollowToken(t){const o=getLeaderId(t);state.writh.followers[o]=_.without(state.writh.followers[o],t);const e=getTokenById(t).get("name");sendChat("System",`${e} stops following others.`)}function setNPCTokenHP(t,e){const n=getSheetAttribute(e,"npc_hpformula"),s=getSheetAttribute(e,"npcd_con");if(!n||!s)return;const r=n.get("current"),i=Math.floor(parseInt(s.get("current"))/2)-5;let[o,a]=r.split("d");a.indexOf("+")>-1&&([a]=a.split("+")),a.indexOf("-")>-1&&([a]=a.split("-"));let c=0;for(let t=0;t<+o;t++)c+=randomInteger(+a)+i;setTimeout(()=>t.set("bar1_link",null),NPC_SETUP_TIME),setTimeout(()=>t.set("bar1_value",c),NPC_SETUP_TIME),setTimeout(()=>t.set("bar1_max",c),NPC_SETUP_TIME)}function resetOrdinals(t){getSelectedTokens(t).forEach(t=>{const e=t.get("represents");delete state.writh.npcs[e];const n=getSheetAttribute(e,"npc_name").get("current");debug(`Resetting ordinals for ${n}.`)})}function trackNPCToken(t,e){const n=state.writh.npcs[e]||[];n.push(t.id),state.writh.npcs[e]=n}function untrackNPCToken(t,e){const n=state.writh.npcs[e]||[],s=n.indexOf(t.id);n.splice(s,1),state.writh.npcs[e]=n}function setOrdinalTokenName(t,e){const n=state.writh.npcs[e]||[],s=getOrdinal(n.length),r=getTokenName(t,e);t.set("name",s+" "+r)}function selectTokenSide(t,e){const n=getTokenName(t,e),s=findObjs({_type:"rollabletable",name:n})[0];if(void 0==s)return;const r=findObjs({_type:"tableitem",_rollabletableid:s.get("_id")});if(r.length<1)return;const i=Math.floor(Math.random()*r.length);debug(`name: ${n}, side: ${i}`),setTimeout(()=>{const e=r[i].get("avatar").replace("/max","/thumb");t.set("currentSide",i),t.set("imgsrc",e)},NPC_SETUP_TIME)}const NPC_SETUP_TIME=500;function resize(e,t){getSelectedTokens(e).forEach(e=>setTokenSize(e,t))}function shapechange(e){getSelectedTokens(e).forEach(e=>{const t=e.get("name"),r=e.get("currentSide"),n=findObjs({_type:"rollabletable",name:t})[0];if(void 0==n)return;const s=findObjs({_type:"tableitem",_rollabletableid:n.get("_id")});if(s.length<1)return;const a=1-r,c=s[a].get("avatar").replace("/max","/thumb");e.set("currentSide",a),e.set("imgsrc",c);const g=e.get("represents"),i=getAttrByName(g,"shapechanger_type").toLowerCase();void 0!=i&&shapechange[i](e,a,g)})}shapechange.dragon=((e,t,r)=>{const n=getSheetAttribute(r,"dragon_size");let s;s=n?n.get("current"):"large",0===t?setTokenSize(e,"medium"):setTokenSize(e,s)}),shapechange.lythari=((e,t,r)=>{const n=getSheetAttribute(r,"strength"),s=getSheetAttribute(r,"speed"),a=getSheetAttribute(r,"ac");let c=getSheetAttribute(r,"lythari_base_strength"),g=getSheetAttribute(r,"lythari_base_speed"),i=getSheetAttribute(r,"lythari_base_ac");c||(c=setSheetAttribute(r,"lythari_base_strength",n.get("current"))),g||(g=setSheetAttribute(r,"lythari_base_speed",s.get("current"))),i||(i=setSheetAttribute(r,"lythari_base_ac",a.get("current"))),1===t?(n.set("current",15),s.set("current",parseInt(g.get("current"))+10),a.set("current",parseInt(i.get("current"))+1)):(n.set("current",c.get("current")),s.set("current",g.get("current")),a.set("current",i.get("current")))});function setBar(a,e,n){const t=a.get("_bar"+e+"_link");""!==t&&findObjs({_type:"attribute",_id:t})[0].set({current:n}),a.set("bar"+e+"_value",n)}const THPBAR=3,HPBAR=1;on("change:token",(a,e)=>{const n={new:parseInt(a.get("bar1_value")),old:parseInt(e.bar1_value)},t=parseInt(a.get("bar3_value")),r={};NaN!==n.new&&n.new!==n.old&&t>0&&(n.change=n.new-n.old,n.change<0&&(n.abschange=Math.abs(n.change),r.bar3_value=t>n.abschange?t-n.abschange:0,r.bar1_value=t>n.abschange?n.old:n.old-(n.abschange-t),setBar(a,1,r.bar1_value),setBar(a,3,r.bar3_value)))});function debug(...t){DEBUG&&log(`[${(new Date).toISOString()}] ${t.join(" ")}`)}function identifyToken(t){const e=getTokenById(t.id||t._id);return{token:e,represents:e.get("represents")}}function isObjectToken(t){return!(t.attributes&&t.attributes.isdrawing||t.isdrawing)}function isNPC(t){const e=t.get("represents"),n=getSheetAttribute(e,"npc"),r=getSheetAttribute(e,"named_npc");return n&&1==n.get("current")&&(!r||0==r.get("current"))}function getTokenById(t,e="graphic"){return getObj(e,t)}function getAllSheetAttributes(t){return findObjs({type:"attribute",characterid:t})}function getOrdinal(t){var e=["th","st","nd","rd"],n=t%100;return t+(e[(n-20)%10]||e[n]||e[0])}function getSelectedTokens(t){return t.selected?t.selected.map(({_id:t,_type:e})=>getTokenById(t,e)):[]}function getSheetAttribute(t,e){return findObjs({type:"attribute",characterid:t,name:e},{caseInsensitive:!0})[0]}function getTokenName(t,e){let n=t.get("name");return n||(n=getSheetAttribute(e,"npc_name").get("current")),n}function modifier(t){return Math.floor(t/2)-5}function setSheetAttribute(t,e,n,r=null){let i=getSheetAttribute(t,e);return i||(i=createObj("attribute",{characterid:t,name:e,current:n,max:r})),i.set("current",n),i.set("max",r),i}function setTokenSize(t,e){t.set("height",TOKEN_SIZES[e]),t.set("width",TOKEN_SIZES[e])}const DEBUG=!0,TOKEN_SIZES={tiny:30,small:50,medium:70,large:140,huge:210,gargantuan:280,colossal:350};